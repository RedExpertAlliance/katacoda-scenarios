In this step you will look at managing a single OCI Resource using Terraform. Just a single Objectstorage Bucket.

Terraform will process all *.tf* files in the current directory (and possibly files in other directories to which references exist).

Execute these statements to set two environment variables -TF_VAR_compartment_id and TF_VAR_namespace - from which Terraform will read the values for some of its variables (*compartment_id* and *namespace*):
```
export TF_VAR_compartment_id=$(oci iam compartment list | jq -r --arg display_name "lab-compartment" '.data | map(select(."name" == $display_name)) | .[0] | .id')
export TF_VAR_namespace=$(oci os ns get| jq -r '.data')
echo "TF_VAR_compartment_id=$TF_VAR_compartment_id"
echo "TF_VAR_namespace=$TF_VAR_namespace"
```{{execute}}

File `main.tf`{{open}} contains the definitions of the OCI resources we want Terraform to manage. If they exist, Terraform should only update them where properties differ in definition and actual state and if they do not exist, Terraform should create them.

In this file, a single bucket is defined. The name of the bucket is set through the variable *lab_bucket_name*. Its default value is *tf-bucket*. However, the name should be more specific. Execute this command to set an environment variable from which the variable will get its value:

`export TF_VAR_lab_bucket_name=tf_lab_bucket_$LAB_ID`{{execute}}

The file also contains the definition of an (file) object called *hello-world-object-in-bucket*. This object resource refers to the bucket resource in which it should be created. The content of the file object is defined - hard coded - in the file *main.tf* as well. Of course it could also be read from an environment variable

## Plan

The following command *plan* is used to create an execution plan. Terraform first performs a refresh: it reads the actual state of affairs on OCI and creates or updates the statefile accordingly. Then it determines what actions are necessary to achieve the desired state specified in the configuration files.

`terraform plan -out config.tfplan`{{execute}}

Note: this step sometimes takes very long - up to several minutes.

## Apply 
To make our plan real, use the following command. Terraform will apply the changes required to reach the desired state of the configuration, or the pre-determined set of actions generated by a terraform plan execution plan.

`terraform apply `{{execute}}

Enter *yes* when prompted to confirm our desire.

The plan is now executed - resulting in the creation of the bucket and the object in the bucket. The result of the these two actions is reported back.

Check on existence of the bucket:
`oci os bucket get --bucket-name="$TF_VAR_lab_bucket_name"`{{execute}}

and on the file:
`oci os object get --bucket-name="$TF_VAR_lab_bucket_name" --name my-new-object --file myfileDownloadedFromOCI`{{execute}}

Check the contents of the file:
`cat myfileDownloadedFromOCI`{{execute}}

## Managed Evolution through repeat Apply 

You can run *apply* again. Terraform will attempt to bring the OCI resource in the state that is defined in fule *main.tf*. Since the resource have just been created based on this file, a second round of *apply* does not actually change anything:

`terraform apply `{{execute}}

However, if you were to make a change in *main.tf* - for example change the content property to *Hello Universe* in the definition of resource *"oci_objectstorage_object" "hello-world-object-in-bucket"* - and run *apply* again, the existing object is replaced with an object with the proper content.

`terraform apply `{{execute}}

Note: Any change you made outside of Terraform to resources managed by Terraform will be overwritten the next time you apply the configuration unless you add the *ignore_changes* parameter to the resource in the configuration file.


## Resources

GitHub Repo with many sample Terraform configurations for OCI Resources https://github.com/terraform-providers/terraform-provider-oci/tree/master/examples 

Example OCI Terraform Provider - Bucket - https://www.terraform.io/docs/providers/oci/r/objectstorage_bucket.html

Terraform Docs on Variables: https://www.terraform.io/docs/configuration/variables.html 

Blog article describing first steps with OCI provider for Terraform - including introduction to variables and data sources: https://technology.amis.nl/2020/02/28/terraform/ 